name: Run tests
description: Apply Testkube CRDs and run all tests and test-cases

runs:
  using: "composite"

  steps:

    - name: Create Testkube CRDs
      shell: bash
      run: |
        kubectl apply -f $TEST_FOLDER_PATH/tests --recursive

    - name: Get Run and Job ID from GH API
      id: get-job-id
      env:
        GH_TOKEN: ${{ env.GITHUB_TOKEN }}
      shell: bash
      run: |
        jobs=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id}}/attempts/${{ github.run_attempt }}/jobs)
        job_id=$(echo $jobs | jq -r '.jobs[] | select(.runner_name=="${{ runner.name }}") | .id')
        echo "JOB_ID=$job_id" >> $GITHUB_ENV
        echo "RUN_ID=${{ github.run_id }}" >> $GITHUB_ENV

    - name: Run all tests
      shell: bash
      run: |
        for test in $(kubectl get tests.tests.testkube.io -n testkube --no-headers -o custom-columns=":metadata.name") ; do
          testkube run test $test --name $test-$RUN_ID-$JOB_ID
        done

    - name: Wait for tests to finish
      shell: bash
      run: |
        kubectl -n testkube wait job --all --for=condition=Complete --timeout=600s

    - name: Print test results
      shell: bash
      run: |
        testkube get execution
        
        for test in $(kubectl get tests.tests.testkube.io -n testkube --no-headers -o custom-columns=":metadata.name") ; do
          testkube get execution $test-$RUN_ID-$JOB_ID
        
          if [[ $(kubectl get tests.tests.testkube.io $test -n testkube -o jsonpath='{.status.latestExecution.status}') != "passed" ]]; then
            echo "Get information about the execution"
            curl -s http://localhost:8088/v1/tests/$test/executions/$test-$RUN_ID-$JOB_ID > ${{ github.workspace }}/execution_result.json
        
            EXECUTION_ID=$(jq -r '.id' ${{ github.workspace }}/execution_result.json)
            echo "EXECUTION_ID=$EXECUTION_ID" >> $GITHUB_ENV
        
            ERROR_MESSAGE=$(jq -r '.executionResult.errorMessage' ${{ github.workspace }}/execution_result.json)
            echo "ERROR_MESSAGE<<EOF" >> $GITHUB_ENV
            echo "$ERROR_MESSAGE" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
        
            TEST_TYPE=$(jq -r '.testType' ${{ github.workspace }}/execution_result.json)
            echo "TEST_TYPE=$TEST_TYPE" >> $GITHUB_ENV
        
            TEST_NAME="$test"
            echo "TEST_NAME=$TEST_NAME" >> $GITHUB_ENV
        
            envsubst < ${{ github.workspace }}/adaptive_card_template.json > ${{ github.workspace }}/adaptive_card.json
            cat ${{ github.workspace }}/adaptive_card.json
        
            echo "Sending adaptive card to Teams"
            curl -X POST --silent --write-out '%{http_code}' --output /dev/null \
              -H "Content-Type: application/json" -d @${{ github.workspace }}/adaptive_card.json \
              $TEAMS_INCOMING_WEBHOOK_URL
        
            exit 1
          fi
        done

    - name: Run all test-suites
      shell: bash
      run: |
        for test in $(kubectl get testsuite.tests.testkube.io -n testkube --no-headers -o custom-columns=":metadata.name") ; do
          testkube run testsuite $test --name $test-$RUN_ID-$JOB_ID
        done

    - name: Wait for test-suites to finish
      shell: bash
      run: |
        kubectl -n testkube wait job --all --for=condition=Complete --timeout=600s

    - name: Print test-suite results
      shell: bash
      run: |
        testkube get testsuiteexecution
        
        for test in $(kubectl get testsuite.tests.testkube.io -n testkube --no-headers -o custom-columns=":metadata.name") ; do
          testkube get execution $test-$RUN_ID-$JOB_ID
          if [[ $(kubectl get testsuite.tests.testkube.io $test -n testkube -o jsonpath='{.status.latestExecution.status}') != "passed" ]]; then
            exit 1
          fi
        done
